<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Tag-verkt√∏y - Adminpanel</title>
    <link href="../assets/css/theme-t√∏ff.css" rel="stylesheet" />
    <style>
        body {
            font-family: var(--font-base);
            padding: 2rem;
        }

        h1 {
            margin-bottom: 1rem;
        }

        .tag-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .tag-table th,
        .tag-table td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            font-size: 0.9rem;
            vertical-align: top;
        }

        .tag-table th {
            background-color: var(--bg-muted);
            cursor: pointer;
        }

        .tag {
            display: inline-block;
            background: var(--bg-card);
            padding: 2px 6px;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .tag.bad {
            background: #ffd2d2;
            color: #a00;
        }

        .tag.good {
            background: #d2ffe1;
            color: #084;
        }

        .tag-edit {
            margin-top: 0.5rem;
            display: block;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        textarea {
            width: 100%;
            min-height: 60px;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        button.save-btn {
            padding: 6px 12px;
            margin-top: 4px;
            font-size: 0.8rem;
            background: var(--btn-primary, #007bff);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .top-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <h1>üõ†Ô∏è Tag-verkt√∏y - Adminpanel</h1>
    <p id="storeCount"></p>
    <div class="top-actions">
        <button class="save-btn" onclick="leggTilTagsFraUnderkategori()">üè∑Ô∏è Foresl√• tags fra underkategori</button>
        <button class="save-btn" onclick="finnDubletter()">üîç Finn dubletter</button>
        <button class="save-btn" onclick="eksporterJSON()">üíæ Eksporter som JSON</button>
        <button class="save-btn" onclick="fjernUonskedeTags()">üßπ Fjern u√∏nskede tags fra alle</button>
        <button class="save-btn" onclick="fjernValgte()">üóë Fjern valgte</button>
    </div>
    <input id="search" placeholder="S√∏k etter tag eller kategori..." type="text" />
    <table class="tag-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAll" title="Merk alle" onclick="toggleAlle(this)"></th>
                <th onclick="sortTableBy('category')">Kategori ‚¨ç</th>
                <th onclick="sortTableBy('name')">Butikknavn ‚¨ç</th>
                <th onclick="sortTableBy('tagCount')">Antall tags ‚¨ç</th>
                <th>Beskrivelse</th>
                <th onclick="sortTableBy('forside')">Forside ‚¨ç</th>
                <th>Rediger tags</th>
            </tr>
        </thead>
        <tbody id="tagTableBody"></tbody>
    </table>
    <pre id="jsonResultat" class="json-output"></pre>
    <script>
        // U√∏nskede tags
        const uonskede = [
            "nettbutikk", "tilbeh√∏r", "alt mulig", "varer", "ting",
            "ting og tang", "diverse", "elektronikk", "butikk",
            "kj√∏p", "online", "digital", "netthandel", "rabatt",
            "shopping", "handel"
        ];

        // Tag-mal brukt for underkategori/kategori
        const tagMal = {
                "Damekl√¶r": [
                    "b√¶rekraftig", "casual", "damebutikk", "damekl√¶r", "fashion", "jeans",
                    "kjole", "komfort", "motebutikk", "mote", "nyheter", "outfit", "plus size",
                    "skj√∏rt", "stil", "sustainable", "trend"
                ],
                "Herrekl√¶r": [
                    "business", "casual", "casual wear", "dress", "formelt", "herrebutikk", "herrekl√¶r",
                    "herremote", "jeans", "outfit", "skjorte", "sustainable"
                ],
                "Barnekl√¶r": [
                    "babykl√¶r", "barnebutikk", "barnekl√¶r", "barnemote", "barnesko", "gutt", "jente",
                    "komfort", "kl√¶r til barn", "sm√•barnskl√¶r", "ullkl√¶r", "√∏kologisk"
                ],
                "Sko og tilbeh√∏r": [
                    "barnesko", "belte", "boots", "komfort", "pensko", "sandaler", "sko", "sko butikk",
                    "sko online", "sneakers", "solbriller", "st√∏vler", "tilbeh√∏r", "vesker", "hansker", "h√•rpynt"
                ],
                "Sportskl√¶r": [
                    "aktiv livsstil", "funksjonst√∏y", "idrettskl√¶r", "jogging", "l√∏pekl√¶r", "outdoor", "skikl√¶r",
                    "sport", "sportskl√¶r", "sportsbutikk", "sykkelkl√¶r", "trening", "treningskl√¶r"
                ],
                "Babyutstyr": [
                    "amme", "baby", "babybutikk", "babyleker", "babyshower", "barnemat", "barnesete", "b√¶resele",
                    "bleier", "gravid", "smokk", "sm√•barn", "stelleveske", "vippestol", "vogn"
                ],
                "Leker": [
                    "babyleker", "barneleker", "bamse", "dukker", "gave", "kreativ lek", "leker",
                    "leket√∏y", "outdoor", "pedagogisk", "puslespill", "spill", "spillbutikk", "utend√∏rsleker"
                ],
                "B√∏ker": [
                    "barneb√∏ker", "billige b√∏ker", "bokhandel", "bokklubb", "b√∏ker", "fagb√∏ker",
                    "klassikere", "litteratur", "papirbok", "roman"
                ],
                "E-b√∏ker": [
                    "digital bok", "e-bok", "elektronisk", "kindle", "lesebrett", "pdf-bok"
                ],
                "Fagb√∏ker": [
                    "akademisk", "fagb√∏ker", "l√¶rebok", "pensum", "studier", "utdanning"
                ],
                "Lyd- og lydb√∏ker": [
                    "audiobok", "fortelling", "lydb√∏ker", "lyttebok", "opplesning"
                ],
                "Mobilabonnement": [
                    "4G", "5G", "data", "mobil", "mobilabonnement", "SIM-kort", "telefoni"
                ],
                "Nettkurs": [
                    "e-l√¶ring", "kompetanse", "kurs", "nettkurs", "online l√¶ring", "utdanning"
                ],
                "Str√∏mleverand√∏rer": [
                    "energileverand√∏r", "spotpris", "str√∏m", "str√∏mavtale", "str√∏mleverand√∏r"
                ],
                "Str√∏mmetjenester": [
                    "abonnement", "filmer", "musikk", "serier", "streaming", "str√∏mming", "TV"
                ],
                "Treningsapper og programmer": [
                    "fitness", "l√∏ping", "online trening", "styrketrening", "treningsapp"
                ],
                "VPN og Nettsikkerhet": [
                    "IP-skjuling", "VPN", "anonymitet", "kryptering", "nettsikkerhet", "personvern"
                ],
                "Webhosting & Domene": [
                    "cPanel", "domene", "e-post", "hosting", "nettside", "server", "webhotell"
                ],
                "Fisk og akvarium": [
                    "akvariedekor", "akvarieutstyr", "akvarium", "fisk", "fiskef√¥r", "vanntest"
                ],
                "F√¥r og ern√¶ring": [
                    "dyreern√¶ring", "dyref√¥r", "hundemat", "kattemat", "kosthold", "vitaminer"
                ],
                "Fugl": [
                    "bur", "fugl", "fuglefr√∏", "fugleleker", "kanarifugl", "papeg√∏ye", "voliere"
                ],
                "Hund": [
                    "halsb√•nd", "hund", "hundebur", "hundeleker", "hundeseng", "sele"
                ],
                "Reptil og terrarie": [
                    "reptil", "reptilf√¥r", "skilpadde", "slange", "terrarium", "varmelampe"
                ],
                "Elektronikk": [
                    "elbil", "elektriske produkter", "elektronikk", "elektronikkbutikk", "gadgets",
                    "mobiltelefon", "nettbutikk", "smarthus", "teknologi"
                ],
                "Lyd og bilde": [
                    "bluetooth", "headset", "hjemmekino", "h√∏yttalere", "h√∏yttaler", "lydanlegg", "projektor",
                    "radio", "tr√•dl√∏st", "tv butikk", "TV"
                ],
                "Mobil og nettbrett": [
                    "Android", "iPad", "mobil", "mobilbutikk", "nettbrett", "smartklokke", "smarttelefon", "tablet", "telefondeksel"
                ],
                "Smarthus og kabler": [
                    "home automation", "sensor", "smartlys", "smarthus", "str√∏mstyring"
                ],
                "Spill og konsoller": [
                    "dataspill", "familiespill", "flerspiller", "gamer", "gaming", "konsoll", "Nintendo",
                    "pc-spill", "PlayStation", "spill", "spillbutikk", "spillutstyr", "Xbox"
                ],
                "Teknologinyheter": [
                    "gadgets", "lansering", "produktomtaler", "tech-nyheter"
                ],
                "Brettspill": [
                    "brettspill", "familiespill", "kortspill", "spillkveld", "strategispill"
                ],
                "E-sportutstyr": [
                    "e-sport", "gamingmus", "gamingtastatur", "headset", "turnering"
                ],
                "Gaming-PC og skjermer": [
                    "bygge PC", "FPS", "gaming-PC", "grafikkort", "prosessor", "skjerm"
                ],
                "Gaming-tilbeh√∏r": [
                    "gamingutstyr", "headset-holder", "musmatte", "RGB", "spillstol"
                ],
                "Konsoller": [
                    "familiespill", "Nintendo Switch", "PlayStation", "spillpakke", "Xbox"
                ],
                "PC og datatilbeh√∏r": [
                    "minnepinne", "mus", "tastatur", "USB-hub", "webkamera"
                ],
                "Gadgets og gaver": [
                    "bursdagsgave", "dings", "gaveideer", "gaver", "julegave", "morsomme produkter",
                    "personlig gave", "smarte ting", "smartklokke", "teknologigave", "teknologi"
                ],
                "Alt-mulig butikker": [
                    "alt mulig", "import", "nettbutikk", "stor katalog", "variert utvalg"
                ],
                "Utenlandske": [
                    "frakt", "internasjonal", "lav pris", "import", "utenlandsk butikk"
                ],
                "Hud- og kroppspleie": [
                    "ansiktsmaske", "fuktighetskrem", "hudpleie", "hudpleiesalong", "kroppskrem", "kroppsolje",
                    "naturlig hudpleie", "parfymeri", "solkrem", "dusjs√•pe"
                ],
                "H√•r- og skj√∏nnhetspleie": [
                    "h√•rkur", "h√•rpleie", "shampoo", "skj√∏nnhet", "styling"
                ],
                "Kosmetikk og sminke": [
                    "foundation", "leppestift", "makeup", "√∏yenskygge", "sminke"
                ],
                "Naturlige produkter": [
                    "b√¶rekraftig", "eco", "kliman√∏ytral", "milj√∏vennlig", "naturlig", "√∏kologisk", "plantebasert", "sustainable", "vegansk"
                ],
                "Sminke og kosmetikk": [
                    "foundation", "makeup", "√∏yne", "kosmetikk", "sminke"
                ],
                "Trening og velv√¶re": [
                    "balanse", "energi", "kosttilskudd", "trening", "velv√¶re", "yoga"
                ],
                "DIY kits og prosjekter": [
                    "byggesett", "DIY", "hobby", "h√•ndverk", "lim", "oppskrifter", "perler", "prosjekt"
                ],
                "Garn og strikk": [
                    "garn", "hekling", "h√•ndarbeid", "oppskrifter", "pinner", "strikking", "ull"
                ],
                "Kunst og tegneutstyr": [
                    "akvarell", "blyanter", "kunstnerutstyr", "maling", "skissebok", "tegning"
                ],
                "Radiostyrte produkter": [
                    "bil", "b√•t", "drone", "modellbygging", "motor", "RC", "radiostyrt"
                ],
                "Dagligvarer": [
                    "dagligvarer", "frossenmat", "kaffe", "nettbutikk", "√∏kologisk mat", "p√•legg"
                ],
                "Frokost og levering": [
                    "br√∏d", "frokost", "matlevering", "morgenmat", "rask levering"
                ],
                "Matkasser": [
                    "familiepakke", "ferdigmat", "matkasse", "matlevering", "middag", "middagstips", "oppskrifter", "sunn mat", "levering", "familievennlig"
                ],
                "Vin og bartilbeh√∏r": [
                    "bartilbeh√∏r", "drinktilbeh√∏r", "glass", "vinkj√∏ler", "vin"
                ],
                "Vin og brennevin": [
                    "alkohol", "brennevin", "cocktail", "smaking", "whisky"
                ],
                "Belysning": [
                    "lamper", "lys", "p√¶rer", "stemningsbelysning", "taklampe"
                ],
                "Dekor og interi√∏r": [
                    "bilder", "dekor", "interi√∏r", "nordisk design", "pynt", "tepper"
                ],
                "M√∏bler": [
                    "barnerom", "bord", "designm√∏bler", "interi√∏rbutikk", "oppbevaring", "outlet", "seng",
                    "skandinavisk stil", "sofa", "sofa p√• nett", "stoler", "utem√∏bler"
                ],
                "Bager og kofferter": [
                    "bag", "bagasje", "koffert", "reiseveske", "trillebag"
                ],
                "Kart og guider": [
                    "destinasjon", "guidebok", "kart", "reiseguider", "turkart"
                ],
                "Reiseutstyr": [
                    "nakkepute", "organisering", "reiseadapter", "reiseutstyr", "toalettmappe"
                ],
                "Tur- og friluftsutstyr": [
                    "friluft", "ryggsekk", "sovepose", "tel", "tur", "telt", "villmark"
                ],
                "Friluft og tur": [
                    "fjelltur", "friluft", "outdoor", "sportsbutikk", "sovepose", "tel", "tur", "turkl√¶r", "telt", "teltbutikk", "utend√∏rs", "villmark"
                ],
                "Treningskl√¶r": [
                    "aktiv livsstil", "funksjonst√∏y", "sports-bh", "tight", "treningskl√¶r"
                ],
                "Sykkel og sykkelutstyr": [
                    "elsykkel", "sykkel", "sykkelhjelm", "sykkellykt", "verkt√∏y"
                ],
                "Sportskl√¶r": [
                    "aktivitetskl√¶r", "funksjonskl√¶r", "l√∏pekl√¶r", "sportst√∏y", "yogat√∏y"
                ],
                "Treningsutstyr": [
                    "apparat", "manualer", "styrketrening", "strikk", "treningsmatte"
                ],
                "Anime og manga": [
                    "anime", "cosplay", "fanartikler", "figurer", "manga", "otaku"
                ],
                "Digitale spilln√∏kler": [
                    "nedlasting", "PC-spill", "rabattkode", "spilln√∏kkel", "Steam"
                ],
                "Figurer og samleobjekter": [
                    "figurer", "merch", "POP!", "samleobjekter", "statuetter"
                ],
                "Film og musikk": [
                    "blu-ray", "CD", "cd-plater", "dvd butikk", "DVD", "filmkveld", "film", "musikkbutikk", "platesamling", "platebutikk", "vinyl"
                ]
            };


        let globalData = [];
        let currentSortKey = null;
        let sortAscending = true;

        // Hent JSON-data
        fetch("../../assets/data/butikker.json")
            .then(res => res.json())
            .then(butikker => {
                globalData = butikker;
                renderTable(globalData);
            });

        // Tabell-render
        function renderTable(butikker) {
            const tbody = document.getElementById("tagTableBody");
            document.getElementById("storeCount").innerText = `Butikker i listen: ${butikker.length}`;
            tbody.innerHTML = "";
            butikker.forEach((butikk, index) => {
                const tr = document.createElement("tr");
                const kategori = butikk.category || "";
                const navn = butikk.name || "";
                const tags = butikk.tags || [];
                const beskrivelse = butikk.description || "";
                const forside = butikk.forside === true;

                // Avkryssningsboks for valg
                const checked = butikk._selected ? 'checked' : '';
                const checkBox = `<input type="checkbox" onchange="velgRad(${index}, this.checked)" ${checked}>`;

                const tagsHTML = tags.map(tag => {
                    // "good" hvis finnes i underkategori/kategori-tagMal, "bad" hvis i u√∏nskede, ellers normal
                    let cls = "";
                    if (uonskede.includes(tag.toLowerCase())) {
                        cls = "tag bad";
                    } else if (
                        (butikk.subcategory && (Array.isArray(butikk.subcategory) ? butikk.subcategory.some(sk => tagMal[sk]?.includes(tag)) : tagMal[butikk.subcategory]?.includes(tag)))
                        || (tagMal[kategori] && tagMal[kategori].includes(tag))
                    ) {
                        cls = "tag good";
                    } else {
                        cls = "tag";
                    }
                    return `<span class="${cls}">${tag}</span>`;
                }).join(" ");

                // Redigerbare felt
                const catInput = `<input type='text' value="${kategori}" onchange="globalData[${index}].category=this.value">`;
                const nameInput = `<input type='text' value="${navn}" onchange="globalData[${index}].name=this.value">`;
                const descInput = `<textarea onchange="globalData[${index}].description=this.value">${beskrivelse}</textarea>`;
                const urlInput = `<input type='text' value="${butikk.url || ''}" onchange="globalData[${index}].url=this.value">`;
                const subInput = `<input type='text' value="${(butikk.subcategory || []).join(', ')}" onchange="globalData[${index}].subcategory=this.value.split(',').map(s => s.trim())">`;
                const imgInput = `<input type='text' value="${butikk.image || ''}" onchange="globalData[${index}].image=this.value">`;
                const altInput = `<input type='text' value="${butikk.alt || ''}" onchange="globalData[${index}].alt=this.value">`;
                const rankInput = `<input type='text' value="${butikk.rank || ''}" onchange="globalData[${index}].rank=this.value">`;

                const boolCheckbox = (key) => `<label><input type='checkbox' ${butikk[key] ? 'checked' : ''} onchange="globalData[${index}]['${key}']=this.checked"> ${key}</label>`;
                const boolFields = ['forside', 'topp25', 'ny', 'annonse', 'ukensAnbefalte']
                    .map(k => boolCheckbox(k)).join("<br>");

                const tagEditor = document.createElement("textarea");
                tagEditor.value = tags.join(", ");
                tagEditor.className = "tag-edit";
                tagEditor.id = `edit-tags-${index}`;

                const saveBtn = document.createElement("button");
                saveBtn.textContent = "Lagre tags";
                saveBtn.className = "save-btn";
                saveBtn.onclick = () => {
                    const updated = tagEditor.value.split(",").map(t => t.trim()).filter(Boolean);
                    globalData[index].tags = updated;
                    renderTable(globalData);
                };

                tr.innerHTML = `
                  <td>${checkBox}</td>
                  <td>${catInput}</td>
                  <td>${nameInput}<br>${urlInput}<br>${imgInput}<br>${altInput}<br>${subInput}</td>
                  <td>${tagsHTML}</td>
                  <td>${descInput}</td>
                  <td style="text-align:center;">${forside ? '‚úÖ' : ''}<br>${boolFields}<br>${rankInput}</td>
                  <td></td>
                `;
                tr.children[6].appendChild(tagEditor);
                tr.children[6].appendChild(saveBtn);
                tbody.appendChild(tr);
            });
        }

        // Marker rad
        function velgRad(idx, checked) {
            globalData[idx]._selected = checked;
        }

        // Merk/avmerk alle
        function toggleAlle(source) {
            globalData.forEach(b => b._selected = source.checked);
            renderTable(globalData);
            document.getElementById("checkAll").checked = source.checked;
        }

        // S√∏kefunksjon
        document.getElementById("search").addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = globalData.filter(butikk => {
                const tekst = `${butikk.category} ${butikk.name} ${(butikk.tags || []).join(" ")}`.toLowerCase();
                return tekst.includes(query);
            });
            renderTable(filtered);
            document.getElementById("checkAll").checked = false;
        });

        // Sortering
        function sortTableBy(key) {
            if (currentSortKey === key) {
                sortAscending = !sortAscending;
            } else {
                currentSortKey = key;
                sortAscending = true;
            }
            globalData.forEach(b => {
                if (key === 'tagCount') b.tagCount = (b.tags || []).length;
            });
            globalData.sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                if (aVal < bVal) return sortAscending ? -1 : 1;
                if (aVal > bVal) return sortAscending ? 1 : -1;
                return 0;
            });
            renderTable(globalData);
            document.getElementById("checkAll").checked = false;
        }

        // Legg til tags fra underkategori (eller kategori som fallback, kun unike)
        function leggTilTagsFraUnderkategori() {
            globalData.forEach((butikk, index) => {
                let nyeTags = [];
                if (butikk.subcategory) {
                    (Array.isArray(butikk.subcategory) ? butikk.subcategory : [butikk.subcategory]).forEach(sk => {
                        if (tagMal[sk]) nyeTags.push(...tagMal[sk]);
                    });
                }
                // Fallback til kategori
                if (nyeTags.length === 0 && tagMal[butikk.category]) {
                    nyeTags = tagMal[butikk.category];
                }
                // Legg til, ikke erstatt!
                if (nyeTags.length > 0) {
                    const eksisterende = new Set(globalData[index].tags || []);
                    nyeTags.forEach(tag => eksisterende.add(tag));
                    globalData[index].tags = Array.from(eksisterende);
                }
            });
            renderTable(globalData);
        }

        // Finn dubletter
        function finnDubletter() {
            const navnMap = {};
            const dubletter = [];
            globalData.forEach((butikk) => {
                const navn = butikk.name?.toLowerCase().trim();
                if (navn) {
                    if (!navnMap[navn]) navnMap[navn] = [];
                    navnMap[navn].push(butikk);
                }
            });
            const resultat = [];
            Object.values(navnMap).forEach(gruppe => {
                if (gruppe.length > 1) resultat.push(...gruppe);
            });
            alert(`Fant ${resultat.length} butikker med dupliserte navn.`);
            renderTable(resultat);
            document.getElementById("checkAll").checked = false;
        }

        // Fjern valgte butikker
        function fjernValgte() {
            if (!confirm('Er du sikker p√• at du vil slette de valgte butikkene?')) return;
            globalData = globalData.filter(butikk => !butikk._selected);
            renderTable(globalData);
            document.getElementById("checkAll").checked = false;
        }

        // Eksporter som JSON
        function eksporterJSON() {
            document.getElementById("jsonResultat").textContent = JSON.stringify(globalData, null, 2);
        }

        // Fjern u√∏nskede tags fra alle butikker
        function fjernUonskedeTags() {
            globalData.forEach((butikk, index) => {
                butikk.tags = (butikk.tags || []).filter(tag => !uonskede.includes(tag.toLowerCase()));
            });
            renderTable(globalData);
        }
    </script>
</body>

</html>