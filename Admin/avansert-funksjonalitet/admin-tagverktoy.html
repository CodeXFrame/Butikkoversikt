<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Tag-verkt√∏y - Adminpanel</title>
    <link href="../assets/css/theme-t√∏ff.css" rel="stylesheet" />
    <style>
        body {
            font-family: var(--font-base);
            padding: 2rem;
        }

        h1 {
            margin-bottom: 1rem;
        }

        .tag-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .tag-table th,
        .tag-table td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            font-size: 0.9rem;
            vertical-align: top;
        }

        .tag-table th {
            background-color: var(--bg-muted);
            cursor: pointer;
        }

        .tag {
            display: inline-block;
            background: var(--bg-card);
            padding: 2px 6px;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .tag.bad {
            background: #ffd2d2;
            color: #a00;
        }

        .tag.good {
            background: #d2ffe1;
            color: #084;
        }

        .tag-edit {
            margin-top: 0.5rem;
            display: block;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        textarea {
            width: 100%;
            min-height: 60px;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        button.save-btn {
            padding: 6px 12px;
            margin-top: 4px;
            font-size: 0.8rem;
            background: var(--btn-primary, #007bff);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .top-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <h1>üõ†Ô∏è Tag-verkt√∏y - Adminpanel</h1>
    <p id="storeCount"></p>
    <div class="top-actions">
        <button class="save-btn" onclick="leggTilTagsFraUnderkategori()">üè∑Ô∏è Foresl√• tags fra underkategori</button>
        <button class="save-btn" onclick="finnDubletter()">üîç Finn dubletter</button>
        <button class="save-btn" onclick="eksporterJSON()">üíæ Eksporter som JSON</button>
        <button class="save-btn" onclick="fjernUonskedeTags()">üßπ Fjern u√∏nskede tags fra alle</button>
        <button class="save-btn" onclick="fjernValgte()">üóë Fjern valgte</button>
    </div>
    <input id="search" placeholder="S√∏k etter tag eller kategori..." type="text" />
    <table class="tag-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAll" title="Merk alle" onclick="toggleAlle(this)"></th>
                <th onclick="sortTableBy('category')">Kategori ‚¨ç</th>
                <th onclick="sortTableBy('name')">Butikknavn ‚¨ç</th>
                <th onclick="sortTableBy('tagCount')">Antall tags ‚¨ç</th>
                <th>Beskrivelse</th>
                <th onclick="sortTableBy('forside')">Forside ‚¨ç</th>
                <th>Rediger tags</th>
            </tr>
        </thead>
        <tbody id="tagTableBody"></tbody>
    </table>
    <pre id="jsonResultat" class="json-output"></pre>
    <script>
        // U√∏nskede tags
        const uonskede = [
            "nettbutikk", "tilbeh√∏r", "alt mulig", "varer", "ting",
            "ting og tang", "diverse", "elektronikk", "butikk",
            "kj√∏p", "online", "digital", "netthandel", "rabatt",
            "shopping", "handel"
        ];

        // Tag-mal brukt for underkategori/kategori
        const tagMal = {
            // ... (din tagMal som f√∏r) ...
            "Damekl√¶r": ["damekl√¶r", "fashion", "mote", "outfit", "stil", "komfort"],
            "Herrekl√¶r": ["herrekl√¶r", "herremote", "outfit", "casual", "formelt"],
            "Barnekl√¶r": ["barnekl√¶r", "barnemote", "kl√¶r til barn", "komfort", "sm√•barnskl√¶r"],
            "Sko og tilbeh√∏r": ["sko", "sandaler", "boots", "sneakers", "vesker", "belte", "solbriller", "tilbeh√∏r", "h√•rpynt", "hansker"],
            "Sportskl√¶r": ["treningskl√¶r", "l√∏pekl√¶r", "yogat√∏y", "funksjonst√∏y", "aktiv livsstil", "idrettskl√¶r"],
            "Babyutstyr": ["baby", "smokk", "flaske", "bleier", "stelleveske", "vogn", "barnesete", "amme", "babyshower"],
            "Leker": ["leker", "leket√∏y", "spill", "puslespill", "pedagogisk", "kreativ lek", "bamse", "dukker", "lego"],
            "B√∏ker": ["b√∏ker", "romaner", "litteratur", "papirbok", "klassikere", "bokhandel"],
            "E-b√∏ker": ["e-bok", "digital bok", "kindle", "pdf-bok", "elektronisk", "lesebrett"],
            "Fagb√∏ker": ["fagb√∏ker", "studier", "utdanning", "l√¶rebok", "akademisk", "pensum"],
            "Lyd- og lydb√∏ker": ["lydb√∏ker", "audiobok", "lyttebok", "opplesning", "fortelling"],
            "Mobilabonnement": ["mobil", "mobilabonnement", "data", "4G", "5G", "telefoni", "SIM-kort"],
            "Nettkurs": ["nettkurs", "e-l√¶ring", "utdanning", "kompetanse", "kurs", "online l√¶ring"],
            "Str√∏mleverand√∏rer": ["str√∏m", "str√∏mleverand√∏r", "str√∏mavtale", "spotpris", "energileverand√∏r"],
            "Str√∏mmetjenester": ["str√∏mming", "filmer", "serier", "TV", "musikk", "streaming", "abonnement"],
            "Treningsapper og programmer": ["treningsapp", "online trening", "fitness", "l√∏ping", "styrketrening"],
            "VPN og Nettsikkerhet": ["VPN", "nettsikkerhet", "anonymitet", "personvern", "IP-skjuling", "kryptering"],
            "Webhosting & Domene": ["webhotell", "hosting", "domene", "nettside", "e-post", "server", "cPanel"],
            "Fisk og akvarium": ["akvarium", "fisk", "fiskef√¥r", "vanntest", "akvarieutstyr", "akvariedekor"],
            "F√¥r og ern√¶ring": ["dyref√¥r", "hundemat", "kattemat", "vitaminer", "dyreern√¶ring", "kosthold"],
            "Fugl": ["fugl", "bur", "fuglefr√∏", "papeg√∏ye", "kanarifugl", "fugleleker", "voliere"],
            "Hund": ["hund", "halsb√•nd", "sele", "hundeseng", "hundeleker", "hundebur"],
            "Reptil og terrarie": ["reptil", "slange", "skilpadde", "terrarium", "varmelampe", "reptilf√¥r"],
            "Elektronikk": ["elektronikk", "teknologi", "smarte enheter", "kabler", "elektriske produkter"],
            "Lyd og bilde": ["h√∏yttaler", "headset", "TV", "projektor", "lydanlegg", "hjemmekino"],
            "Mobil og nettbrett": ["mobil", "smarttelefon", "nettbrett", "telefondeksel", "Android", "iOS"],
            "Smarthus og kabler": ["smarthus", "sensor", "smartlys", "home automation", "str√∏mstyring"],
            "Spill og konsoller": ["spill", "konsoll", "PlayStation", "Xbox", "Nintendo", "flerspiller"],
            "Teknologinyheter": ["tech-nyheter", "gadgets", "produktomtaler", "lansering"],
            "Brettspill": ["brettspill", "familiespill", "strategispill", "kortspill", "spillkveld"],
            "E-sportutstyr": ["e-sport", "gamingmus", "gamingtastatur", "headset", "turnering"],
            "Gaming-PC og skjermer": ["gaming-PC", "skjerm", "FPS", "grafikkort", "prosessor", "bygge PC"],
            "Gaming-tilbeh√∏r": ["spillstol", "RGB", "musmatte", "headset-holder", "gamingutstyr"],
            "Konsoller": ["PlayStation", "Xbox", "Nintendo Switch", "spillpakke", "familiespill"],
            "PC og datatilbeh√∏r": ["mus", "tastatur", "USB-hub", "webkamera", "minnepinne"],
            "Gadgets og gaver": ["gadgets", "gaver", "smarte ting", "teknologi", "gaveideer", "personlig gave", "morsomme produkter"],
            "Alt-mulig butikker": ["nettbutikk", "variert utvalg", "alt mulig", "stor katalog", "import"],
            "Utenlandske": ["internasjonal", "import", "frakt", "utenlandsk butikk", "lav pris"],
            "Hud- og kroppspleie": ["hudpleie", "kroppskrem", "dusjs√•pe", "fuktighetskrem", "naturlig hudpleie"],
            "H√•r- og skj√∏nnhetspleie": ["shampoo", "h√•rkur", "styling", "skj√∏nnhet", "h√•rpleie"],
            "Kosmetikk og sminke": ["sminke", "leppestift", "√∏yenskygge", "foundation", "makeup"],
            "Naturlige produkter": ["naturlig", "√∏kologisk", "vegansk", "b√¶rekraftig", "plantebasert"],
            "Sminke og kosmetikk": ["sminke", "kosmetikk", "foundation", "makeup", "√∏yne"],
            "Trening og velv√¶re": ["trening", "kosttilskudd", "velv√¶re", "yoga", "balanse", "energi"],
            "DIY kits og prosjekter": ["DIY", "byggesett", "lim", "oppskrifter", "perler", "prosjekt", "hobby", "h√•ndverk"],
            "Garn og strikk": ["strikking", "garn", "hekling", "oppskrifter", "pinner", "ull", "h√•ndarbeid"],
            "Kunst og tegneutstyr": ["tegning", "maling", "akvarell", "blyanter", "skissebok", "kunstnerutstyr"],
            "Radiostyrte produkter": ["RC", "radiostyrt", "bil", "b√•t", "drone", "motor", "modellbygging"],
            "Dagligvarer": ["dagligvarer", "p√•legg", "kaffe", "frossenmat", "√∏kologisk mat"],
            "Frokost og levering": ["frokost", "br√∏d", "morgenmat", "matlevering", "rask levering"],
            "Matkasser": ["matkasse", "oppskrifter", "middag", "levering", "familievennlig"],
            "Vin og bartilbeh√∏r": ["vin", "vinkj√∏ler", "glass", "bartilbeh√∏r", "drinktilbeh√∏r"],
            "Vin og brennevin": ["brennevin", "whisky", "cocktail", "smaking", "alkohol"],
            "Belysning": ["lamper", "lys", "p√¶rer", "taklampe", "stemningsbelysning"],
            "Dekor og interi√∏r": ["interi√∏r", "dekor", "bilder", "pynt", "tepper", "nordisk design"],
            "M√∏bler": ["sofa", "bord", "stoler", "seng", "oppbevaring", "skandinavisk stil"],
            "Bager og kofferter": ["koffert", "bag", "reiseveske", "bagasje", "trillebag"],
            "Kart og guider": ["reiseguider", "kart", "turkart", "guidebok", "destinasjon"],
            "Reiseutstyr": ["reiseadapter", "nakkepute", "toalettmappe", "organisering", "reiseutstyr"],
            "Tur- og friluftsutstyr": ["friluft", "tur", "ryggsekk", "sovepose", "telt", "villmark"],
            "Friluft og tur": ["friluft", "tur", "sovepose", "villmark", "fjell", "telt", "utend√∏rs"],
            "Treningskl√¶r": ["treningskl√¶r", "tight", "sports-bh", "aktiv livsstil", "funksjonst√∏y"],
            "Sykkel og sykkelutstyr": ["sykkel", "sykkelhjelm", "elsykkel", "sykkellykt", "verkt√∏y"],
            "Sportskl√¶r": ["l√∏pekl√¶r", "sportst√∏y", "aktivitetskl√¶r", "yogat√∏y", "funksjonskl√¶r"],
            "Treningsutstyr": ["manualer", "treningsmatte", "styrketrening", "strikk", "apparat"],
            "Anime og manga": ["anime", "manga", "figurer", "otaku", "cosplay", "fanartikler"],
            "Digitale spilln√∏kler": ["spilln√∏kkel", "Steam", "PC-spill", "nedlasting", "rabattkode"],
            "Figurer og samleobjekter": ["samleobjekter", "figurer", "merch", "POP!", "statuetter"],
            "Film og musikk": ["DVD", "blu-ray", "vinyl", "CD", "filmkveld", "platebutikk"]
        };

        let globalData = [];
        let currentSortKey = null;
        let sortAscending = true;

        // Hent JSON-data
        fetch("../../assets/data/butikker.json")
            .then(res => res.json())
            .then(butikker => {
                globalData = butikker;
                renderTable(globalData);
            });

        // Tabell-render
        function renderTable(butikker) {
            const tbody = document.getElementById("tagTableBody");
            document.getElementById("storeCount").innerText = `Butikker i listen: ${butikker.length}`;
            tbody.innerHTML = "";
            butikker.forEach((butikk, index) => {
                const tr = document.createElement("tr");
                const kategori = butikk.category || "";
                const navn = butikk.name || "";
                const tags = butikk.tags || [];
                const beskrivelse = butikk.description || "";
                const forside = butikk.forside === true;

                // Avkryssningsboks for valg
                const checked = butikk._selected ? 'checked' : '';
                const checkBox = `<input type="checkbox" onchange="velgRad(${index}, this.checked)" ${checked}>`;

                const tagsHTML = tags.map(tag => {
                    // "good" hvis finnes i underkategori/kategori-tagMal, "bad" hvis i u√∏nskede, ellers normal
                    let cls = "";
                    if (uonskede.includes(tag.toLowerCase())) {
                        cls = "tag bad";
                    } else if (
                        (butikk.subcategory && (Array.isArray(butikk.subcategory) ? butikk.subcategory.some(sk => tagMal[sk]?.includes(tag)) : tagMal[butikk.subcategory]?.includes(tag)))
                        || (tagMal[kategori] && tagMal[kategori].includes(tag))
                    ) {
                        cls = "tag good";
                    } else {
                        cls = "tag";
                    }
                    return `<span class="${cls}">${tag}</span>`;
                }).join(" ");

                // Redigerbare felt
                const catInput = `<input type='text' value="${kategori}" onchange="globalData[${index}].category=this.value">`;
                const nameInput = `<input type='text' value="${navn}" onchange="globalData[${index}].name=this.value">`;
                const descInput = `<textarea onchange="globalData[${index}].description=this.value">${beskrivelse}</textarea>`;
                const urlInput = `<input type='text' value="${butikk.url || ''}" onchange="globalData[${index}].url=this.value">`;
                const subInput = `<input type='text' value="${(butikk.subcategory || []).join(', ')}" onchange="globalData[${index}].subcategory=this.value.split(',').map(s => s.trim())">`;
                const imgInput = `<input type='text' value="${butikk.image || ''}" onchange="globalData[${index}].image=this.value">`;
                const altInput = `<input type='text' value="${butikk.alt || ''}" onchange="globalData[${index}].alt=this.value">`;
                const rankInput = `<input type='text' value="${butikk.rank || ''}" onchange="globalData[${index}].rank=this.value">`;

                const boolCheckbox = (key) => `<label><input type='checkbox' ${butikk[key] ? 'checked' : ''} onchange="globalData[${index}]['${key}']=this.checked"> ${key}</label>`;
                const boolFields = ['forside', 'topp25', 'ny', 'annonse', 'ukensAnbefalte']
                    .map(k => boolCheckbox(k)).join("<br>");

                const tagEditor = document.createElement("textarea");
                tagEditor.value = tags.join(", ");
                tagEditor.className = "tag-edit";
                tagEditor.id = `edit-tags-${index}`;

                const saveBtn = document.createElement("button");
                saveBtn.textContent = "Lagre tags";
                saveBtn.className = "save-btn";
                saveBtn.onclick = () => {
                    const updated = tagEditor.value.split(",").map(t => t.trim()).filter(Boolean);
                    globalData[index].tags = updated;
                    renderTable(globalData);
                };

                tr.innerHTML = `
                  <td>${checkBox}</td>
                  <td>${catInput}</td>
                  <td>${nameInput}<br>${urlInput}<br>${imgInput}<br>${altInput}<br>${subInput}</td>
                  <td>${tagsHTML}</td>
                  <td>${descInput}</td>
                  <td style="text-align:center;">${forside ? '‚úÖ' : ''}<br>${boolFields}<br>${rankInput}</td>
                  <td></td>
                `;
                tr.children[6].appendChild(tagEditor);
                tr.children[6].appendChild(saveBtn);
                tbody.appendChild(tr);
            });
        }

        // Marker rad
        function velgRad(idx, checked) {
            globalData[idx]._selected = checked;
        }

        // Merk/avmerk alle
        function toggleAlle(source) {
            globalData.forEach(b => b._selected = source.checked);
            renderTable(globalData);
            document.getElementById("checkAll").checked = source.checked;
        }

        // S√∏kefunksjon
        document.getElementById("search").addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = globalData.filter(butikk => {
                const tekst = `${butikk.category} ${butikk.name} ${(butikk.tags || []).join(" ")}`.toLowerCase();
                return tekst.includes(query);
            });
            renderTable(filtered);
            document.getElementById("checkAll").checked = false;
        });

        // Sortering
        function sortTableBy(key) {
            if (currentSortKey === key) {
                sortAscending = !sortAscending;
            } else {
                currentSortKey = key;
                sortAscending = true;
            }
            globalData.forEach(b => {
                if (key === 'tagCount') b.tagCount = (b.tags || []).length;
            });
            globalData.sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                if (aVal < bVal) return sortAscending ? -1 : 1;
                if (aVal > bVal) return sortAscending ? 1 : -1;
                return 0;
            });
            renderTable(globalData);
            document.getElementById("checkAll").checked = false;
        }

        // Legg til tags fra underkategori (eller kategori som fallback, kun unike)
        function leggTilTagsFraUnderkategori() {
            globalData.forEach((butikk, index) => {
                let nyeTags = [];
                if (butikk.subcategory) {
                    (Array.isArray(butikk.subcategory) ? butikk.subcategory : [butikk.subcategory]).forEach(sk => {
                        if (tagMal[sk]) nyeTags.push(...tagMal[sk]);
                    });
                }
                // Fallback til kategori
                if (nyeTags.length === 0 && tagMal[butikk.category]) {
                    nyeTags = tagMal[butikk.category];
                }
                // Legg til, ikke erstatt!
                if (nyeTags.length > 0) {
                    const eksisterende = new Set(globalData[index].tags || []);
                    nyeTags.forEach(tag => eksisterende.add(tag));
                    globalData[index].tags = Array.from(eksisterende);
                }
            });
            renderTable(globalData);
        }

        // Finn dubletter
        function finnDubletter() {
            const navnMap = {};
            const dubletter = [];
            globalData.forEach((butikk) => {
                const navn = butikk.name?.toLowerCase().trim();
                if (navn) {
                    if (!navnMap[navn]) navnMap[navn] = [];
                    navnMap[navn].push(butikk);
                }
            });
            const resultat = [];
            Object.values(navnMap).forEach(gruppe => {
                if (gruppe.length > 1) resultat.push(...gruppe);
            });
            alert(`Fant ${resultat.length} butikker med dupliserte navn.`);
            renderTable(resultat);
            document.getElementById("checkAll").checked = false;
        }

        // Fjern valgte butikker
        function fjernValgte() {
            if (!confirm('Er du sikker p√• at du vil slette de valgte butikkene?')) return;
            globalData = globalData.filter(butikk => !butikk._selected);
            renderTable(globalData);
            document.getElementById("checkAll").checked = false;
        }

        // Eksporter som JSON
        function eksporterJSON() {
            document.getElementById("jsonResultat").textContent = JSON.stringify(globalData, null, 2);
        }

        // Fjern u√∏nskede tags fra alle butikker
        function fjernUonskedeTags() {
            globalData.forEach((butikk, index) => {
                butikk.tags = (butikk.tags || []).filter(tag => !uonskede.includes(tag.toLowerCase()));
            });
            renderTable(globalData);
        }
    </script>
</body>

</html>